<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <title>Donor Admin Panel</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
        margin-bottom: 2rem;
        background-image: url(images/bgg1.png);
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed;
      }
      .card-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      .card {
        width: 25%;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: 1s ease;
        margin: 1rem;
      }
      .card:hover {
        transform: scale(1.03);
        background-color: #fceee9;
      }
      .card img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
      }
      .top-right-container {
        display: flex;
        justify-content: flex-end;
        margin: 15px;
      }
      #search-form {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin: 15px;
      }
      #area-suggestions {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        z-index: 10;
        max-height: 150px;
        overflow-y: auto;
        width: 200px;
      }
      #area-suggestions div {
        padding: 5px;
        cursor: pointer;
      }
      #area-suggestions div:hover {
        background-color: #eee;
      }
      @media (max-width: 768px) {
        .card {
          width: 80%;
        }
      }
      @media (max-width: 480px) {
        .card {
          width: 95%;
        }
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1055;
      }

      .shadow-3d {
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.25),
          0px 8px 20px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <div class="shadow-3d">
      <nav
        class="navbar navbar-expand-lg navbar-light bg-success mb-4 d-flex justify-content-center position-relative"
      >
        <!-- Centered content -->
        <div class="text-center w-100 text-white">
          <h1 class="font-weight-bold display-6 m-0">Admin Dashboard</h1>
          <p class="font-weight-light m-0">
            Manage donors and their information
          </p>
        </div>

        <!-- Logout button (top right) -->
        <div class="position-absolute" style="right: 20px; top: 10px">
          <button id="logoutButton" class="btn btn-danger">Logout</button>
        </div>
      </nav>
    </div>

    <!-- search by blood group filter -->
    <form id="search-form">
      <select id="bgFilter" class="form-control" style="width: 150px">
        <option value="">All Blood Groups</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
      </select>
      <!-- search by area filter -->
      <div style="position: relative">
        <input
          type="text"
          id="areaFilter"
          class="form-control"
          placeholder="Search by area"
          autocomplete="off"
        />
        <div id="area-suggestions"></div>
      </div>
      <button type="submit" class="btn btn-primary">Search</button>
      <button type="button" id="clearFilters" class="btn btn-secondary">
        Clear Filters
      </button>
    </form>

    <div id="loading" class="text-center" style="display: none">
      Loading donors...
    </div>
    <div id="card-container" class="card-container"></div>
    <div id="pagination" class="text-center mt-3"></div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="editForm">
          <div class="modal-header">
            <h5 class="modal-title">Edit Donor</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editId" />
            <div class="form-group">
              <label>Name</label
              ><input type="text" class="form-control" id="editName" />
            </div>
            <div class="form-group">
              <label>Age</label
              ><input type="number" class="form-control" id="editAge" />
            </div>
            <div class="form-group">
              <label>Blood Group</label
              ><input type="text" class="form-control" id="editBG" />
            </div>
            <div class="form-group">
              <label>Availability</label
              ><input type="text" class="form-control" id="editAvail" />
            </div>
            <div class="form-group">
              <label>Address</label
              ><input type="text" class="form-control" id="editAddr" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="actionToast" data-delay="3000">
      <div class="toast-body bg-success text-white"></div>
    </div>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        deleteDoc,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyByXCNpzcqr1j6czX8WXuOpK1DofNsfYZI",
        authDomain: "my-1st-login-signup-page.firebaseapp.com",
        projectId: "my-1st-login-signup-page",
        storageBucket: "my-1st-login-signup-page.appspot.com",
        messagingSenderId: "141690543001",
        appId: "1:141690543001:web:c799c675498bc394d11108",
      };
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      // DOM elements
      const logoutBtn = document.getElementById("logoutButton");
      const cardContainer = document.getElementById("card-container");
      const loading = document.getElementById("loading");
      const bgFilter = document.getElementById("bgFilter");
      const areaFilter = document.getElementById("areaFilter");
      const areaSuggestions = document.getElementById("area-suggestions");
      const searchForm = document.getElementById("search-form");
      const clearBtn = document.getElementById("clearFilters");
      const pagination = document.getElementById("pagination");
      const toast = document.getElementById("actionToast");
      const toastBody = toast.querySelector(".toast-body");

      let donorsData = [],
        currentPage = 1,
        allAreas = [];
      const itemsPerPage = 9;

      onAuthStateChanged(auth, (user) => {
        const isGuest = localStorage.getItem("guestMode") === "true";
        if (user || isGuest) {
          if (!isGuest) logoutBtn.style.display = "block";
          getData();
          if (isGuest) localStorage.removeItem("guestMode");
        } else {
          location.href = "adminLoginBS.html";
        }
      });

      logoutBtn.onclick = async () => {
        await signOut(auth);
        alert("You have been logged out.");
        location.href = "adminLoginBS.html";
      };

      clearBtn.onclick = () => {
        bgFilter.value = "";
        areaFilter.value = "";
        currentPage = 1;
        renderCards();
      };

      searchForm.onsubmit = (e) => {
        e.preventDefault();
        currentPage = 1;
        renderCards();
      };

      areaFilter.oninput = () => {
        const input = areaFilter.value.toLowerCase();
        const matches = allAreas
          .filter((a) => a.toLowerCase().includes(input))
          .slice(0, 5);
        areaSuggestions.innerHTML = matches
          .map((m) => `<div>${m}</div>`)
          .join("");
        areaSuggestions.style.display = matches.length ? "block" : "none";
      };

      areaSuggestions.onclick = (e) => {
        if (e.target.tagName === "DIV") {
          areaFilter.value = e.target.textContent;
          areaSuggestions.innerHTML = "";
        }
      };

      async function getData() {
        loading.style.display = "block";
        const snapshot = await getDocs(collection(db, "donors"));
        donorsData = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        allAreas = [
          ...new Set(donorsData.map((d) => d.address || "").filter(Boolean)),
        ];
        loading.style.display = "none";
        renderCards();
      }

      function filterDonors() {
        const bg = bgFilter.value;
        const area = areaFilter.value.trim().toLowerCase();
        return donorsData.filter(
          (d) =>
            (!bg || d.bg === bg) &&
            (!area || (d.address && d.address.toLowerCase().includes(area)))
        );
      }

      function renderCards() {
        const data = filterDonors();
        const start = (currentPage - 1) * itemsPerPage;
        const paginated = data.slice(start, start + itemsPerPage);
        cardContainer.innerHTML = "";
        paginated.forEach((d) => {
          const card = document.createElement("div");
          card.className = "card";
          const nameFormatted = d.name
            .toLowerCase()
            .replace(/\b\w/g, (c) => c.toUpperCase());

          card.innerHTML = `
      <img src="${
        d.profilePhoto || "https://www.w3schools.com/w3images/avatar2.png"
      }" />
      <p>NAME: <strong>${nameFormatted}</strong></p>
      <p>GENDER: ${d.gender || "N/A"}</p>
      <p>AGE: ${d.age}</p>
      <p>BG : <span style="color: red;font-weight: bold;">${d.bg}</span>ðŸ©¸</p>
      <p>ADDRESS: ${d.address}</p>
      <p>AVAILABILITY: <span style="color: ${
        d.availability.toLowerCase() === "available" ? "green" : "red"
      }";>${d.availability}</span></p>
      <button class="btn btn-sm btn-warning edit-btn" data-id="${
        d.id
      }">Edit</button>
      <button class="btn btn-sm btn-danger delete-btn" data-id="${
        d.id
      }">Delete</button>
    `;
          cardContainer.appendChild(card);
        });
        renderPagination(data.length);
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            await deleteDoc(doc(db, "donors", id));
            showToast("Donor deleted.");
            getData();
          };
        });
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.id;
            const d = donorsData.find((x) => x.id === id);
            document.getElementById("editId").value = d.id;
            document.getElementById("editName").value = d.name || "";
            document.getElementById("editAge").value = d.age || "";
            document.getElementById("editBG").value = d.bg || "";
            document.getElementById("editAvail").value = d.availability || "";
            document.getElementById("editAddr").value = d.address || "";
            $("#editModal").modal("show");
          };
        });
      }

      function renderPagination(total) {
        const pages = Math.ceil(total / itemsPerPage);
        pagination.innerHTML = "";
        for (let i = 1; i <= pages; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = `btn btn-sm ${
            i === currentPage ? "btn-primary" : "btn-light"
          } mx-1`;
          btn.onclick = () => {
            currentPage = i;
            renderCards();
          };
          pagination.appendChild(btn);
        }
      }

      function showToast(msg) {
        toastBody.textContent = msg;
        $(toast).toast("show");
      }

      document.getElementById("editForm").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("editId").value;
        const donorRef = doc(db, "donors", id);
        await updateDoc(donorRef, {
          name: document.getElementById("editName").value,
          age: document.getElementById("editAge").value,
          bg: document.getElementById("editBG").value,
          availability: document.getElementById("editAvail").value,
          address: document.getElementById("editAddr").value,
        });
        $("#editModal").modal("hide");
        showToast("Donor updated successfully.");
        getData();
      };
    </script>

    <!-- Bootstrap Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
